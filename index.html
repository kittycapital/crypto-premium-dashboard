<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê¹€ì¹˜/ì½”ì¸ë² ì´ìŠ¤ í”„ë¦¬ë¯¸ì—„ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#08080d;--card:#101018;--elev:#1a1a28;--border:#1c1c2e;--border2:#2a2a45;
  --t1:#e8e8f0;--t2:#8888a8;--t3:#555570;
  --green:#00d68f;--green-d:#00d68f33;--red:#ff3d71;--red-d:#ff3d7133;
  --blue:#3366ff;--orange:#f0a030;--purple:#9966ff;--cyan:#00cfff;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--t1);font-family:'Noto Sans KR',sans-serif;line-height:1.6;scrollbar-width:none;-ms-overflow-style:none}
body::-webkit-scrollbar{display:none}
.mono{font-family:'JetBrains Mono',monospace}

.header{padding:24px 28px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0c0c14,var(--bg))}
.header-top{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.header h1{font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px}
.header-meta{display:flex;align-items:center;gap:16px;font-size:11px;color:var(--t3)}
.dot{width:6px;height:6px;background:var(--green);border-radius:50%;display:inline-block;margin-right:4px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

.rate-bar{display:flex;gap:16px;margin-top:8px;font-size:12px;flex-wrap:wrap;align-items:center}
.rate-item{display:flex;align-items:center;gap:4px;color:var(--t2)}
.rate-val{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--t1)}
.ok{color:var(--green)}.ld{color:var(--orange)}.fl{color:var(--red)}

.status-bar{display:flex;gap:14px;margin-top:6px;font-size:10px;color:var(--t3);flex-wrap:wrap}

.period-sel{display:flex;gap:4px;margin-top:12px;overflow-x:auto;scrollbar-width:none}
.period-sel::-webkit-scrollbar{display:none}
.pbtn{padding:6px 16px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--t2);font-size:12px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0}
.pbtn:hover{border-color:var(--border2);color:var(--t1)}
.pbtn.active{background:var(--blue);color:#fff;border-color:var(--blue);font-weight:600}

.dashboard{max-width:1400px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}

/* Signal */
.sig-banner{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.sig-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px 18px;overflow:hidden}
.sig-box h3{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.sig-box.prem h3{color:var(--green)}
.sig-box.disc h3{color:var(--red)}
.sig-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;cursor:pointer}
.sig-item:last-child{border-bottom:none}
.sig-item:hover{background:var(--elev)}
.sig-item .ci{display:flex;align-items:center;gap:8px}
.sig-item .ci img{width:20px;height:20px;border-radius:50%}
.sig-item .cs{font-family:'JetBrains Mono',monospace;font-weight:600}
.sig-item .vals{display:flex;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px}
.sig-item .v-up{color:var(--cyan)}
.sig-item .v-bt{color:var(--purple)}
.sig-item .v-cb{color:var(--orange)}
.sig-item .v-max{font-weight:700;font-size:13px}

/* Table */
.section{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px}
.stitle{font-size:14px;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.ssub{font-size:11px;color:var(--t3);margin-bottom:14px}
.twrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.twrap::-webkit-scrollbar{height:4px}
.twrap::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

.ctable{width:100%;border-collapse:collapse;font-size:13px;min-width:900px}
.ctable th{padding:8px 10px;font-size:10px;font-weight:500;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);text-align:right;white-space:nowrap;cursor:pointer;user-select:none}
.ctable th:first-child,.ctable th:nth-child(2){text-align:left}
.ctable th:hover{color:var(--t2)}
.ctable th.sorted{color:var(--blue)}
.ctable td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:nowrap;color:var(--t1)}
.ctable td:first-child{text-align:center;color:var(--t3);font-size:11px;width:30px}
.ctable td:nth-child(2){text-align:left;font-family:'Noto Sans KR',sans-serif}
.ctable tr:hover td{background:var(--elev)}
.ctable tr{cursor:pointer}
.cc{display:flex;align-items:center;gap:8px}
.cc img{width:22px;height:22px;border-radius:50%}
.cc .sym{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:13px;color:var(--t1)}
.cc .nm{color:var(--t2);font-size:11px;margin-left:4px}
.pos{color:var(--green)}.neg{color:var(--red)}
.lc{color:var(--t3);font-size:11px;font-style:italic}

.up-c{color:var(--cyan)}.bt-c{color:var(--purple)}.cb-c{color:var(--orange)}

/* Chart */
.chart-box{position:relative;width:100%;height:320px}
.dh{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px}
.dc{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:700}
.dc img{width:28px;height:28px;border-radius:50%}
.ds{display:flex;gap:16px;font-size:12px}
.ds .st{display:flex;flex-direction:column;align-items:center}
.ds .sl{font-size:10px;color:var(--t3);text-transform:uppercase}
.ds .sv{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:14px}

.footer{text-align:center;padding:20px;font-size:10px;color:var(--t3);border-top:1px solid var(--border)}
.loading{display:flex;align-items:center;justify-content:center;height:200px;color:var(--t3);font-size:14px}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}

.countdown{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--t3);margin-left:8px}

@media(max-width:900px){
  .header{padding:16px 14px 12px}.dashboard{padding:12px;gap:12px}.section{padding:14px}
  .chart-box{height:260px}.sig-banner{grid-template-columns:1fr}
}
@media(max-width:500px){
  .header h1{font-size:17px}.ctable{font-size:11px}
  .pbtn{padding:8px 14px;font-size:13px}.chart-box{height:230px}
  .dc{font-size:16px}.ds .sv{font-size:12px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1>ğŸ‡°ğŸ‡· í”„ë¦¬ë¯¸ì—„ ëŒ€ì‹œë³´ë“œ</h1>
    <div class="header-meta">
      <span><span class="dot"></span> 30ì´ˆ ìë™ê°±ì‹ </span>
      <span class="countdown" id="countdown">30s</span>
    </div>
  </div>
  <div class="rate-bar">
    <div class="rate-item">USD/KRW: <span class="rate-val" id="rateDisplay">-</span></div>
    <div class="rate-item">BTC ê¹€ì¹˜: <span class="rate-val" id="btcKimchi">-</span></div>
    <div class="rate-item">BTC ì½”ë² : <span class="rate-val" id="btcCB">-</span></div>
  </div>
  <div class="status-bar">
    <span>Binance: <span id="sBn" class="ld">Â·Â·Â·</span></span>
    <span>ì—…ë¹„íŠ¸: <span id="sUp" class="ld">Â·Â·Â·</span></span>
    <span>ë¹—ì¸: <span id="sBt" class="ld">Â·Â·Â·</span></span>
    <span>Coinbase: <span id="sCb" class="ld">Â·Â·Â·</span></span>
  </div>
  <div class="period-sel">
    <button class="pbtn active" data-period="1">1ì¼</button>
    <button class="pbtn" data-period="7">1ì£¼</button>
    <button class="pbtn" data-period="30">1ë‹¬</button>
  </div>
</div>

<div class="dashboard">
  <div class="sig-banner" id="sigBanner">
    <div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>

  <div class="section">
    <div class="stitle">ğŸ“‹ ì „ì²´ ì½”ì¸ í”„ë¦¬ë¯¸ì—„</div>
    <div class="ssub">ê¸°ì¤€: Binance USDT Â· ì—…ë¹„íŠ¸/ë¹—ì¸/Coinbase ëŒ€ë¹„ í”„ë¦¬ë¯¸ì—„ (%) Â· 30ì´ˆ ìë™ê°±ì‹ </div>
    <div class="twrap" id="tableWrap">
      <div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <div class="section" id="chartSection" style="display:none">
    <div class="dh" id="chartHeader"></div>
    <div class="chart-box" id="chartBox"><canvas id="mainChart"></canvas></div>
  </div>
</div>

<div class="footer">
  ê¸°ì¤€ê°€: Binance USDT Â· ì—…ë¹„íŠ¸/ë¹—ì¸ (KRWâ†’USD í™˜ìœ¨ ì—­ì‚°) Â· Coinbase (USD) Â· íˆ¬ì ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤
</div>

<script>
const isMobile = window.innerWidth <= 600;
let coinMeta = {};      // symbol -> {name, image, rank}
let binancePrices = {};  // symbol -> usd
let upbitPrices = {};    // symbol -> krw
let bithumbPrices = {};  // symbol -> krw
let coinbasePrices = {}; // symbol -> usd
let usdKrw = 0;
let premiums = [];       // [{symbol, upbit%, bithumb%, coinbase%, max%}]
let historyData = [];    // from server
let selectedCoin = null;
let mainChart = null;
let sortState = {col:'max_prem',dir:'desc'};
let refreshTimer = 30;
let refreshInterval = null;

if(typeof Chart!=='undefined'){
  Chart.defaults.color='#8888a8';Chart.defaults.borderColor='#1c1c2e';
  Chart.defaults.font.family="'JetBrains Mono','Noto Sans KR',monospace";
  Chart.defaults.font.size=isMobile?10:11;
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtKRW=(v)=>v>=1000?'â‚©'+v.toLocaleString('ko-KR',{maximumFractionDigits:0}):v>=1?'â‚©'+v.toFixed(2):'â‚©'+v.toFixed(4);
const fmtUSD=(v)=>v>=1000?'$'+v.toLocaleString('en-US',{maximumFractionDigits:0}):v>=1?'$'+v.toFixed(2):v>=0.01?'$'+v.toFixed(4):'$'+v.toFixed(6);
const fmtPct=(v)=>v!=null?(v>0?'+':'')+v.toFixed(2)+'%':'â€”';
const pctCls=(v)=>v>0?'pos':v<0?'neg':'';

// â”€â”€â”€ Fetch Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchBinance(){
  try{
    const r=await fetch('https://api.binance.com/api/v3/ticker/price');
    if(!r.ok)return false;
    const d=await r.json();
    binancePrices={};
    d.forEach(t=>{
      if(t.symbol.endsWith('USDT')){
        const s=t.symbol.replace('USDT','');
        binancePrices[s]=parseFloat(t.price);
      }
    });
    return true;
  }catch(e){return false;}
}

async function fetchUpbit(){
  try{
    // Get KRW market list
    const mr=await fetch('https://api.upbit.com/v1/market/all?isDetails=false');
    if(!mr.ok)return false;
    const markets=await mr.json();
    const krw=markets.filter(m=>m.market.startsWith('KRW-')).map(m=>m.market);
    
    // Fetch prices in batches
    upbitPrices={};
    for(let i=0;i<krw.length;i+=100){
      const batch=krw.slice(i,i+100).join(',');
      const r=await fetch(`https://api.upbit.com/v1/ticker?markets=${batch}`);
      if(r.ok){
        const d=await r.json();
        d.forEach(t=>{
          const s=t.market.replace('KRW-','');
          upbitPrices[s]=parseFloat(t.trade_price);
        });
      }
      if(i+100<krw.length)await new Promise(r=>setTimeout(r,200));
    }
    return true;
  }catch(e){return false;}
}

async function fetchBithumb(){
  try{
    const r=await fetch('https://api.bithumb.com/public/ticker/ALL_KRW');
    if(!r.ok)return false;
    const d=await r.json();
    if(d.status!=='0000')return false;
    bithumbPrices={};
    for(const[sym,info]of Object.entries(d.data)){
      if(sym==='date')continue;
      const p=parseFloat(info.closing_price);
      if(p>0)bithumbPrices[sym]=p;
    }
    return true;
  }catch(e){return false;}
}

async function fetchCoinbase(){
  try{
    const r=await fetch('https://api.coinbase.com/v2/exchange-rates?currency=USD');
    if(!r.ok)return false;
    const d=await r.json();
    const rates=d.data?.rates||{};
    coinbasePrices={};
    for(const[coin,rate]of Object.entries(rates)){
      const v=parseFloat(rate);
      if(v>0)coinbasePrices[coin.toUpperCase()]=1/v;
    }
    return true;
  }catch(e){return false;}
}

// â”€â”€â”€ Calculate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calculate(){
  // Exchange rate: Upbit BTC / Binance BTC
  const upBTC=upbitPrices['BTC']||0;
  const bnBTC=binancePrices['BTC']||0;
  if(upBTC>0&&bnBTC>0) usdKrw=upBTC/bnBTC;
  
  document.getElementById('rateDisplay').textContent=usdKrw>0?usdKrw.toFixed(1)+'ì›':'â€”';
  
  // Collect all symbols that have Binance price
  const symbols=new Set(Object.keys(binancePrices));
  
  premiums=[];
  for(const sym of symbols){
    const bnPrice=binancePrices[sym];
    if(!bnPrice||bnPrice<=0)continue;
    
    const upKRW=upbitPrices[sym];
    const btKRW=bithumbPrices[sym];
    const cbUSD=coinbasePrices[sym];
    
    // Need at least one exchange to compare
    if(!upKRW&&!btKRW&&!cbUSD)continue;
    
    const meta=coinMeta[sym]||{};
    const entry={
      symbol:sym,
      name:meta.name||sym,
      image:meta.image||'',
      rank:meta.market_cap_rank||999,
      bn_usd:bnPrice,
    };
    
    if(upKRW&&usdKrw>0){
      entry.up_krw=upKRW;
      entry.up_prem=((upKRW/usdKrw)-bnPrice)/bnPrice*100;
    }
    if(btKRW&&usdKrw>0){
      entry.bt_krw=btKRW;
      entry.bt_prem=((btKRW/usdKrw)-bnPrice)/bnPrice*100;
    }
    if(cbUSD){
      entry.cb_usd=cbUSD;
      entry.cb_prem=(cbUSD-bnPrice)/bnPrice*100;
    }
    
    // Max premium across exchanges
    const vals=[entry.up_prem,entry.bt_prem,entry.cb_prem].filter(v=>v!=null);
    entry.max_prem=vals.length>0?Math.max(...vals):null;
    entry.min_prem=vals.length>0?Math.min(...vals):null;
    
    premiums.push(entry);
  }
  
  // BTC summary
  const btc=premiums.find(p=>p.symbol==='BTC');
  if(btc){
    document.getElementById('btcKimchi').innerHTML=btc.up_prem!=null?`<span class="${pctCls(btc.up_prem)}">${fmtPct(btc.up_prem)}</span>`:'â€”';
    document.getElementById('btcCB').innerHTML=btc.cb_prem!=null?`<span class="${pctCls(btc.cb_prem)}">${fmtPct(btc.cb_prem)}</span>`:'â€”';
  }
}

// â”€â”€â”€ Load & Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMeta(){
  try{
    const r=await fetch('data/coins.json');
    const d=await r.json();
    d.coins?.forEach(c=>{
      coinMeta[c.symbol]={name:c.name,image:c.image,market_cap_rank:c.market_cap_rank};
    });
  }catch(e){}
}

async function loadHistory(){
  try{
    // Load available history files
    const today=new Date();
    historyData=[];
    for(let i=0;i<30;i++){
      const d=new Date(today);d.setDate(d.getDate()-i);
      const fname=d.toISOString().slice(0,10)+'.json';
      try{
        const r=await fetch(`data/history/${fname}`);
        if(r.ok){const data=await r.json();historyData.push(...data);}
      }catch(e){}
    }
    historyData.sort((a,b)=>a.timestamp.localeCompare(b.timestamp));
  }catch(e){}
}

async function refresh(){
  const s=id=>document.getElementById(id);
  
  const [bn,up,bt,cb]=await Promise.all([
    fetchBinance(),fetchUpbit(),fetchBithumb(),fetchCoinbase()
  ]);
  
  s('sBn').textContent=bn?'âœ“':'âœ—';s('sBn').className=bn?'ok':'fl';
  s('sUp').textContent=up?'âœ“':'âœ—';s('sUp').className=up?'ok':'fl';
  s('sBt').textContent=bt?'âœ“':'âœ—';s('sBt').className=bt?'ok':'fl';
  s('sCb').textContent=cb?'âœ“':'âœ—';s('sCb').className=cb?'ok':'fl';
  
  calculate();
  renderBanner();
  renderTable();
  if(selectedCoin)renderChart(selectedCoin);
  
  refreshTimer=30;
}

async function init(){
  await loadMeta();
  loadHistory();
  await refresh();
  
  refreshInterval=setInterval(()=>{
    refreshTimer--;
    document.getElementById('countdown').textContent=refreshTimer+'s';
    if(refreshTimer<=0)refresh();
  },1000);
}

// â”€â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBanner(){
  const withPrem=premiums.filter(p=>p.max_prem!=null);
  if(!withPrem.length){
    document.getElementById('sigBanner').innerHTML='<div class="loading"><div class="spinner"></div>ë°ì´í„° ë¡œë”© ì¤‘...</div>';
    return;
  }
  
  const sorted=[...withPrem].sort((a,b)=>b.max_prem-a.max_prem);
  const top5=sorted.slice(0,5);
  const bot5=sorted.slice(-5).reverse();
  
  document.getElementById('sigBanner').innerHTML=`
    <div class="sig-box prem"><h3>ğŸ”º í”„ë¦¬ë¯¸ì—„ TOP 5</h3>${top5.map(c=>sigItem(c,'prem')).join('')}</div>
    <div class="sig-box disc"><h3>ğŸ”» ë””ìŠ¤ì¹´ìš´íŠ¸ TOP 5</h3>${bot5.map(c=>sigItem(c,'disc')).join('')}</div>`;
}

function sigItem(c,type){
  const maxVal=type==='prem'?c.max_prem:c.min_prem;
  const cls=maxVal>0?'pos':'neg';
  return`<div class="sig-item" onclick="selectCoin('${c.symbol}')">
    <div class="ci">
      <img src="${c.image}" onerror="this.style.display='none'">
      <span class="cs">${c.symbol}</span>
    </div>
    <div class="vals">
      ${c.up_prem!=null?`<span class="v-up">${fmtPct(c.up_prem)}</span>`:''}
      ${c.bt_prem!=null?`<span class="v-bt">${fmtPct(c.bt_prem)}</span>`:''}
      ${c.cb_prem!=null?`<span class="v-cb">${fmtPct(c.cb_prem)}</span>`:''}
    </div>
  </div>`;
}

// â”€â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(){
  const data=sortData([...premiums],sortState.col,sortState.dir);
  const si=c=>sortState.col===c?(sortState.dir==='asc'?' â†‘':' â†“'):'';
  const sc=c=>sortState.col===c?'sorted':'';
  
  let h=`<table class="ctable"><thead><tr>
    <th onclick="doSort('rank')" class="${sc('rank')}">#${si('rank')}</th>
    <th onclick="doSort('symbol')" class="${sc('symbol')}">ì½”ì¸${si('symbol')}</th>
    <th onclick="doSort('bn_usd')" class="${sc('bn_usd')}">Binance$${si('bn_usd')}</th>
    <th onclick="doSort('up_krw')" class="${sc('up_krw')}">ì—…ë¹„íŠ¸â‚©${si('up_krw')}</th>
    <th onclick="doSort('up_prem')" class="${sc('up_prem')}">ì—…ë¹„íŠ¸%${si('up_prem')}</th>
    <th onclick="doSort('bt_krw')" class="${sc('bt_krw')}">ë¹—ì¸â‚©${si('bt_krw')}</th>
    <th onclick="doSort('bt_prem')" class="${sc('bt_prem')}">ë¹—ì¸%${si('bt_prem')}</th>
    <th onclick="doSort('cb_usd')" class="${sc('cb_usd')}">Coinbase$${si('cb_usd')}</th>
    <th onclick="doSort('cb_prem')" class="${sc('cb_prem')}">CB%${si('cb_prem')}</th>
  </tr></thead><tbody>`;
  
  data.forEach(c=>{
    h+=`<tr onclick="selectCoin('${c.symbol}')">
      <td>${c.rank<999?c.rank:'-'}</td>
      <td><div class="cc"><img src="${c.image}" onerror="this.style.display='none'">
        <span class="sym">${c.symbol}</span><span class="nm">${c.name}</span></div></td>
      <td>${fmtUSD(c.bn_usd)}</td>
      <td>${c.up_krw?fmtKRW(c.up_krw):'<span class="lc">â€”</span>'}</td>
      <td class="${c.up_prem!=null?pctCls(c.up_prem):''}">${c.up_prem!=null?fmtPct(c.up_prem):'<span class="lc">â€”</span>'}</td>
      <td>${c.bt_krw?fmtKRW(c.bt_krw):'<span class="lc">â€”</span>'}</td>
      <td class="${c.bt_prem!=null?pctCls(c.bt_prem):''}">${c.bt_prem!=null?fmtPct(c.bt_prem):'<span class="lc">â€”</span>'}</td>
      <td>${c.cb_usd?fmtUSD(c.cb_usd):'<span class="lc">â€”</span>'}</td>
      <td class="${c.cb_prem!=null?pctCls(c.cb_prem):''}">${c.cb_prem!=null?fmtPct(c.cb_prem):'<span class="lc">â€”</span>'}</td>
    </tr>`;
  });
  
  h+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=h;
}

function sortData(arr,col,dir){
  return arr.sort((a,b)=>{
    let va,vb;
    switch(col){
      case 'rank':va=a.rank||999;vb=b.rank||999;break;
      case 'symbol':return dir==='asc'?a.symbol.localeCompare(b.symbol):b.symbol.localeCompare(a.symbol);
      case 'bn_usd':va=a.bn_usd||0;vb=b.bn_usd||0;break;
      case 'up_krw':va=a.up_krw||0;vb=b.up_krw||0;break;
      case 'up_prem':va=a.up_prem??-999;vb=b.up_prem??-999;break;
      case 'bt_krw':va=a.bt_krw||0;vb=b.bt_krw||0;break;
      case 'bt_prem':va=a.bt_prem??-999;vb=b.bt_prem??-999;break;
      case 'cb_usd':va=a.cb_usd||0;vb=b.cb_usd||0;break;
      case 'cb_prem':va=a.cb_prem??-999;vb=b.cb_prem??-999;break;
      case 'max_prem':va=a.max_prem??-999;vb=b.max_prem??-999;break;
      default:va=0;vb=0;
    }
    return dir==='asc'?va-vb:vb-va;
  });
}

function doSort(col){
  if(sortState.col===col)sortState.dir=sortState.dir==='asc'?'desc':'asc';
  else{sortState.col=col;sortState.dir=col==='rank'?'asc':'desc';}
  renderTable();
}

// â”€â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectCoin(symbol){
  selectedCoin=symbol;
  renderChart(symbol);
}

function renderChart(symbol){
  const c=premiums.find(p=>p.symbol===symbol);
  if(!c)return;
  
  const sec=document.getElementById('chartSection');
  sec.style.display='block';
  
  document.getElementById('chartHeader').innerHTML=`
    <div class="dc"><img src="${c.image}" onerror="this.style.display='none'">${symbol} í”„ë¦¬ë¯¸ì—„ ì¶”ì´</div>
    <div class="ds">
      <div class="st"><span class="sl">ì—…ë¹„íŠ¸</span><span class="sv up-c">${c.up_prem!=null?fmtPct(c.up_prem):'â€”'}</span></div>
      <div class="st"><span class="sl">ë¹—ì¸</span><span class="sv bt-c">${c.bt_prem!=null?fmtPct(c.bt_prem):'â€”'}</span></div>
      <div class="st"><span class="sl">Coinbase</span><span class="sv cb-c">${c.cb_prem!=null?fmtPct(c.cb_prem):'â€”'}</span></div>
    </div>`;
  
  // Filter history by period
  const periodDays=parseInt(document.querySelector('.pbtn.active').dataset.period);
  const cutoff=new Date();cutoff.setDate(cutoff.getDate()-periodDays);
  
  const filtered=historyData.filter(h=>new Date(h.timestamp)>=cutoff&&h.coins[symbol]);
  
  if(filtered.length===0){
    document.getElementById('chartBox').innerHTML='<div class="loading">íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤ (ì„œë²„ ìˆ˜ì§‘ í›„ í‘œì‹œ)</div>';
    sec.scrollIntoView({behavior:'smooth',block:'start'});
    return;
  }
  
  document.getElementById('chartBox').innerHTML='<canvas id="mainChart"></canvas>';
  
  const labels=filtered.map(h=>{
    const d=new Date(h.timestamp);
    return`${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  });
  
  const upData=filtered.map(h=>h.coins[symbol]?.up??null);
  const btData=filtered.map(h=>h.coins[symbol]?.bt??null);
  
  const datasets=[
    {label:'ì—…ë¹„íŠ¸',data:upData,borderColor:'#00cfff',backgroundColor:'#00cfff20',fill:false,tension:.3,pointRadius:0,pointHoverRadius:4,borderWidth:2,spanGaps:true},
    {label:'ë¹—ì¸',data:btData,borderColor:'#9966ff',backgroundColor:'#9966ff20',fill:false,tension:.3,pointRadius:0,pointHoverRadius:4,borderWidth:2,spanGaps:true},
  ];
  
  // Zero line
  const zeroLine={label:'0%',data:filtered.map(()=>0),borderColor:'#333350',borderDash:[4,4],pointRadius:0,borderWidth:1,fill:false};
  datasets.push(zeroLine);
  
  if(mainChart)mainChart.destroy();
  mainChart=new Chart(document.getElementById('mainChart'),{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{intersect:false,mode:'index'},
      plugins:{
        legend:{labels:{boxWidth:isMobile?8:12,padding:isMobile?8:14,filter:i=>i.text!=='0%'}},
        tooltip:{backgroundColor:'#1a1a28',borderColor:'#2a2a45',borderWidth:1,
          callbacks:{label:i=>i.dataset.label!=='0%'?`${i.dataset.label}: ${i.raw!=null?i.raw.toFixed(2)+'%':'â€”'}`:null},
          filter:i=>i.dataset.label!=='0%'}
      },
      scales:{
        x:{grid:{display:false},ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:isMobile?5:10}},
        y:{grid:{color:'#1c1c2e44'},ticks:{callback:v=>v+'%'}}
      }
    }
  });
  
  sec.scrollIntoView({behavior:'smooth',block:'start'});
}

// â”€â”€â”€ Period â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.pbtn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelector('.pbtn.active').classList.remove('active');
    b.classList.add('active');
    if(selectedCoin)renderChart(selectedCoin);
  });
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();

// â”€â”€â”€ iframe height â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function postHeight(){const h=document.documentElement.scrollHeight;window.parent.postMessage({type:'resize',height:h},'*');window.parent.postMessage({height:h},'*');window.parent.postMessage(JSON.stringify({event:'setHeight',height:h}),'*');}
new ResizeObserver(()=>postHeight()).observe(document.body);
window.addEventListener('load',()=>setTimeout(postHeight,500));
setInterval(postHeight,2000);
</script>
</body>
</html>
